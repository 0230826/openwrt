name: Build OpenWrt Official Firmware

# 触发条件：push代码 或 手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # 严谨模式：任何命令失败立即终止
    defaults:
      run:
        shell: bash -e {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
              sudo apt update || { echo "Apt Update Error!"; exit 1; }
              sudo apt full-upgrade -y || { echo "Apt Upgrade Error!"; exit 1; }
              sudo apt install -y python3-apt python3-pip
              pip3 install setuptools
              sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
              gettext git libncurses5-dev libssl-dev rsync unzip zlib1g-dev \
              file wget || { echo "Install Dependencies Error!"; exit 1; }
              sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true

      - name: Download Source & Feeds (With Retry & Mirror)
        run: |
          # 替换 OpenWrt 官方源为 GitHub 镜像，解决 503 错误
          sed -i 's|https://git.openwrt.org|https://github.com/0230826/openwrt|g' feeds.conf.default || { echo "Replace Feed Source Error!"; exit 1; }
          
          # Feeds 更新重试机制：最多3次，间隔10秒
          retry=3
          while [ $retry -gt 0 ]; do
              echo "Feeds update attempt: $((4 - retry))"
              ./scripts/feeds update -a && break
              retry=$((retry-1))
              echo "Feeds update failed, retrying in 10s... ($retry left)"
              sleep 10
          done
          if [ $retry -eq 0 ]; then
              echo "Feeds Update Failed After 3 Retries!"
              exit 1
          fi
          
          # Feeds 安装：报错立即停止
          ./scripts/feeds install -a || { echo "Feeds Install Error!"; exit 1; }

      - name: Load Custom Config (If Exists)
        run: |
          if [ -f .config ]; then
              mv .config .config.bak
              make defconfig || { echo "Make Defconfig Error!"; exit 1; }
              mv .config.bak .config
              make defconfig || { echo "Load Custom Config Error!"; exit 1; }
          else
              # 无自定义配置时生成默认配置
              make defconfig || { echo "Generate Default Config Error!"; exit 1; }
          fi

      - name: Download Compile Dependencies
        run: |
          make download -j$(nproc) || { echo "Download Dependencies Error!"; exit 1; }
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        run: |
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || { echo "Compile Firmware Error!"; exit 1; }

      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_Official_Firmware_${{ github.sha }}
          path: bin/targets/

          retention-days: 30


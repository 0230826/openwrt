name: OpenWrt Online Build
on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/openwrt-build.yml'
      - 'config.seed'
      - 'luci-app-mypackage/**'
  workflow_dispatch: # 允许手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04 # 稳定编译环境
    steps:
      - name: 1. 拉取 Ubuntu 环境并安装依赖
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          sudo rm -rf /var/lib/apt/lists/*
          # 开启报错停止
          set -e

      - name: 2. 拉取 OpenWrt 源码（以 Lean 源码为例，可替换为官方）
        run: |
          git clone --depth=1 https://github.com/0230826/openwrt.git openwrt
          cd openwrt
          # 更新 feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          set -e

      - name: 3. 复制自定义包和配置文件
        run: |
          # 复制自定义包到源码 package 目录
          # cp -rf ../luci-app-mypackage ./openwrt/package/
          # 复制 config.seed 到源码根目录
          # cp ./config.seed ./openwrt/
          cd openwrt
          # 导入配置并补全默认选项
          cat config.seed > .config
          make defconfig
          set -e

      - name: 4. 开始编译固件
        run: |
          cd openwrt
          set -e
          # 第一步：单独构建交叉编译工具链（关键）
          make toolchain/install -j1 V=s
          # 第二步：刷新环境变量，确保编译器被识别
          export PATH=$PATH:$(pwd)/staging_dir/toolchain-mipsel_24kc_musl/bin
          # 第三步：再编译软件包和固件
          make package/compile -j1 V=s 2>&1 | tee build.log
          # 检查编译器是否生成
          ls -l $(pwd)/staging_dir/toolchain-mipsel_24kc_musl/bin/mipsel-openwrt-linux-musl-gcc
          # 若不存在，直接报错停止
          if [ ! -f "$(pwd)/staging_dir/toolchain-mipsel_24kc_musl/bin/mipsel-openwrt-linux-musl-gcc" ]; then
            echo "Toolchain build failed!"
            exit 1
          fi

      - name: 5. 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Firmware-${{ github.run_id }}
          path: openwrt/bin/targets/**/*.bin
          retention-days: 90 # 产物保存90天
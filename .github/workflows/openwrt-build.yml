name: OpenWrt Online Build
on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/openwrt-build.yml'
      - 'config.seed'
      - 'luci-app-mypackage/**'
  workflow_dispatch: # 允许手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04 # 稳定编译环境
    steps:
      - name: 1. 拉取 Ubuntu 环境并安装依赖
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          sudo rm -rf /var/lib/apt/lists/*
          # 开启报错停止
          set -e

      - name: 2. 拉取 OpenWrt 源码（以 Lean 源码为例，可替换为官方）
        run: |
          git clone --depth=1 https://github.com/0230826/openwrt.git openwrt
          cd openwrt
          # 更新 feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          set -e

      - name: 3. 复制自定义包和配置文件
        run: |
          # 复制自定义包到源码 package 目录
          # cp -rf ../luci-app-mypackage ./openwrt/package/
          # 复制 config.seed 到源码根目录
          # cp ./config.seed ./openwrt/
          cd openwrt
          # 导入配置并补全默认选项
          cat config.seed > .config
          make defconfig
          set -e

      - name: 4. 开始编译固件
        run: |
          cd openwrt
          # 多线程编译（-j 后的数字=CPU核心数，默认自动适配）
          make -j$(nproc) download V=s
          make -j$(nproc) V=s
          set -e

      - name: 5. 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Firmware-${{ github.run_id }}
          path: openwrt/bin/targets/**/*.bin
          retention-days: 90 # 产物保存90天
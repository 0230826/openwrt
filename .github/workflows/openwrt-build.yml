name: Build OpenWrt Official Firmware
on:
  push:
    branches: [ main ]  # 触发分支，可改为23.05等稳定分支
    paths:
      - '.github/workflows/openwrt-build.yml'
      - '.config'  # 仅修改配置或脚本时触发编译
  workflow_dispatch:  # 允许手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04  # 稳定版 runner，避免兼容性问题
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          # 官方编译依赖，缺一不可
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget
          sudo apt autoremove -y && sudo apt clean -y
          # 强制报错即停止
          set -e

      - name: Load Custom Config
        run: |
          # 若仓库根目录有.config，直接使用；无则自动生成默认配置
          if [ -f .config ]; then
            mv .config .config.bak
            make defconfig
            mv .config.bak .config
          else
            make defconfig
          fi
          # 检查配置有效性，报错则终止
          make kernel_oldconfig > /dev/null 2>&1 || { echo "Config Error!"; exit 1; }
          set -e

      - name: Download Source & Feeds
        run: |
          # 仅拉取官方 feed，无自定义源
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # 下载编译所需文件，超时时间设为1小时
          make download -j8 V=s || { echo "Download Failed!"; exit 1; }
          set -e

      - name: Compile Firmware
        run: |
          # 获取 CPU 核心数，最大化编译效率
          CORE_COUNT=$(nproc)
          # -j 后接核心数，V=s 显示编译详情，报错即停
          make -j${CORE_COUNT} V=s || { echo "Compile Error!"; exit 1; }
          set -e

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Official-Firmware-${{ github.sha }}
          path: bin/targets/**/*.bin  # 上传所有.bin格式固件
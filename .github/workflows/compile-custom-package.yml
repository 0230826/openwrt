name: Compile OpenWrt Custom Package

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'package/local/fake-luci-pro/**'
      - '.github/workflows/compile-custom-package.yml'

jobs:
  compile-package:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出仓库代码
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 1

      # 步骤2：安装编译依赖
      - name: Install Build Dependencies
        run: |
          set -e  # 全局开启报错停止
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-full rsync unzip zlib1g-dev file wget
          sudo apt clean -y

      # 步骤3：拉取OpenWrt源码（先克隆，再拷贝包）
      - name: Clone OpenWrt Source Code
        uses: actions/checkout@v4
        with:
          repository: 0230826/openwrt
          ref: main
          path: openwrt
          fetch-depth: 1

      # 步骤4：拷贝自定义包到OpenWrt（取消注释+调整顺序，关键！）
      - name: Copy Custom Package to OpenWrt
        run: |
          set -e
          mkdir -p ./openwrt/package/local
          cp -r ./repo/package/local/fake-luci-pro ./openwrt/package/local/

      # 步骤5：缓存优化
      - name: Cache OpenWrt Resources
        uses: actions/cache@v3
        id: package-cache
        with:
          path: |
            ./openwrt/dl
            ./openwrt/staging_dir/host
            ./openwrt/staging_dir/toolchain-*
          key: ${{ runner.os }}-fake-luci-${{ hashFiles('./repo/package/local/fake-luci-pro/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-fake-luci-

      # 步骤6：更新&安装Feeds（set -e 开头生效）
      - name: Update & Install Feeds
        working-directory: ./openwrt
        run: |
          set -e
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # 验证依赖包是否存在
          if ! ./scripts/feeds search -r base uhttpd-mod-cgi > /dev/null; then
              echo "Error: uhttpd-mod-cgi not found in base feed"
              exit 1
          fi

      # 步骤7：生成配置+强制启用包和依赖（新增uhttpd-mod-cgi启用）
      - name: Generate Config & Enable Package
        working-directory: ./openwrt
        run: |
          set -e
          make defconfig
          # 强制启用自定义包 + 其依赖
          echo "CONFIG_PACKAGE_uhttpd-mod-cgi=y" >> .config
          echo "CONFIG_PACKAGE_fake-luci-pro=y" >> .config
          make download -j$(nproc)
          find dl -size -1024c -delete

      # 步骤8：构建Host工具
      - name: Build Host Tools
        working-directory: ./openwrt
        run: |
          set -e
          make tools/install -j$(nproc) V=s
          make toolchain/install -j$(nproc) V=s

      # 步骤9：失败后清理重建工具链
      - name: Clean & Rebuild Toolchain on Failure
        if: failure()
        working-directory: ./openwrt
        run: |
          set -e
          make dirclean
          make toolchain/install -j1 V=s

      # 步骤10：单独编译自定义包
      - name: Compile fake-luci-pro Package
        working-directory: ./openwrt
        run: |
          set -e
          make package/fake-luci-pro/clean
          make package/fake-luci-pro/compile V=s -j$(nproc)

      # 步骤11：上传IPK产物
      - name: Upload IPK Package
        uses: actions/upload-artifact@v4
        with:
          name: fake-luci-pro-ipk
          path: |
            ./openwrt/bin/**/packages/**/fake-luci-pro_*.ipk
            ./openwrt/bin/**/packages/**/fake-luci-pro_*.buildinfo
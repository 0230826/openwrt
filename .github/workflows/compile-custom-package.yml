# OpenWrt 单独编译自定义LuCI包（luci-app-mypackage）
name: Compile OpenWrt Custom Package

# 触发方式：手动触发（推荐，开发测试按需执行）+ 推送到main分支时触发（可选）
on:
  workflow_dispatch:  # 手动触发（核心，在GitHub仓库Actions页面点「Run workflow」即可）
  push:
    branches: [ main ]
    paths:  # 仅当自定义包相关文件修改时，推送才触发编译，避免无用编译
      - 'package/luci-app-mypackage/**'
      - '.github/workflows/compile-custom-package.yml'

# 作业配置：ubuntu最新版（OpenWrt编译官方推荐）
jobs:
  compile-package:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：设置编译环境（安装OpenWrt编译必需依赖，一次性安装）
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-full rsync unzip zlib1g-dev file wget

      # 步骤2：拉取OpenWrt源码（替换为你自己的OpenWrt源码仓库/分支，比如官方openwrt/openwrt）
      - name: Clone OpenWrt source code
        uses: actions/checkout@v4
        with:
          repository: 0230826/openwrt  # 你的OpenWrt源码仓库（可改自己fork的仓库）
          ref: main                    # 源码分支（如23.05、main，和你固件编译的分支一致）
          path: openwrt                # 源码存放目录，固定为openwrt
          fetch-depth: 1

      # 步骤3：将你的自定义包luci-app-mypackage放到OpenWrt源码的package目录下
      - name: Copy custom package to OpenWrt package dir
        run: |
          # 方式1：如果你的包在当前仓库的package/luci-app-mypackage，直接拷贝（推荐）
          # cp -r ./package/luci-app-mypackage ./openwrt/package/
          # 方式2：如果包在其他仓库，用git clone拉取（按需替换）
          # git clone https://你的仓库/luci-app-mypackage.git ./openwrt/package/luci-app-mypackage

      # 步骤4：更新并安装OpenWrt Feeds（必须，你的包依赖luci-compat/luci-lib-nixio来自luci feeds）
      - name: Update and install OpenWrt Feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 步骤5：生成默认编译配置（无需make menuconfig，快速生成基础配置）
      - name: Generate default config
        working-directory: ./openwrt
        run: |
          make defconfig  # 生成默认配置，自动适配架构
          make download -j$(nproc)  # 预下载所有依赖源码，避免编译时卡顿
          find dl -size -1024c -delete  # 删除空文件，防止编译报错

      # 步骤5.1：构建 OpenWrt 所需的 host 工具（修复 CI 中 staging_dir/host/bin 缺失的问题）
      - name: Build host tools required by OpenWrt
        working-directory: ./openwrt
        run: |
          # 构建/安装 host 工具，会在 staging_dir/host/bin 下生成 openssl、sed 等可执行程序
          # 在 CI 上使用 -j1 更稳健，避免并行编译导致不可预期的竞态问题
          make tools/install -j1
          
      - name: Clean and Rebuild Toolchain on Failure
        if: failure()
        run: |
          make dirclean
          make toolchain/install -j1 V=s

      # 步骤6：单独编译自定义包luci-app-mypackage（核心步骤）
      - name: Compile custom package only
        working-directory: ./openwrt
        run: |
          # 核心命令：编译指定包，V=s输出详细日志（排错用），-j指定线程（自动拉满）
          make package/luci-app-mypackage/compile V=s -j$(nproc)
          # 可选：如果需要重新编译（清理旧编译文件），用下面的命令
          # make package/luci-app-mypackage/clean && make package/luci-app-mypackage/compile V=s -j$(nproc)

      # 步骤7：上传编译好的ipk包作为Action产物（可直接下载到本地/设备）
      - name: Upload IPK package
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-mypackage-ipk
          # 匹配所有架构的ipk包（也可指定架构，如bin/armvirt/64/packages/luci/）
          path: |
            ./openwrt/bin/**/packages/**/luci-app-mypackage_*.ipk
            ./openwrt/bin/**/packages/**/luci-app-mypackage_*.buildinfo
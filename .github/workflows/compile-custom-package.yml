name: Compile OpenWrt Custom Package

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'package/local/fake-luci-pro/**'  # 匹配你的包实际路径
      - '.github/workflows/compile-custom-package.yml'

jobs:
  compile-package:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出仓库代码（包含你的OpenWrt源码+自定义包）
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: repo  # 代码存到repo目录，避免和openwrt目录混淆
          fetch-depth: 1

      # 步骤2：安装编译依赖
      - name: Install Build Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-full rsync unzip zlib1g-dev file wget
          sudo apt clean -y

      # 步骤3：关键！拷贝自定义包到OpenWrt源码的package目录（匹配你的实际路径）
      - name: Copy Custom Package to OpenWrt
        run: |
          # mkdir -p ./openwrt/package/local
          # cp -r ./repo/package/local/fake-luci-pro ./openwrt/package/local/

      # 步骤4：拉取OpenWrt源码（若你的repo根目录就是OpenWrt源码，可修改此步路径）
      - name: Clone OpenWrt Source Code
        uses: actions/checkout@v4
        with:
          repository: 0230826/openwrt
          ref: main
          path: openwrt
          fetch-depth: 1

      # ========== 新增：缓存优化！解决重复编译慢的问题 ==========
      - name: Cache OpenWrt Resources
        uses: actions/cache@v3
        id: package-cache
        with:
          path: |
            ./openwrt/dl
            ./openwrt/staging_dir/host
            ./openwrt/staging_dir/toolchain-*
          key: ${{ runner.os }}-fake-luci-${{ hashFiles('./repo/package/local/fake-luci-pro/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-fake-luci-

      # 步骤5：更新Feeds + 安装依赖
      - name: Update & Install Feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          set -e  # 报错立即停止

      # 步骤6：生成配置 + 强制启用自定义包（关键！否则编译不到）
      - name: Generate Config & Enable Package
        working-directory: ./openwrt
        run: |
          make defconfig
          # 强制将fake-luci-pro加入编译配置，不管menuconfig是否选中
          echo "CONFIG_PACKAGE_fake-luci-pro=y" >> .config
          make download -j$(nproc)
          find dl -size -1024c -delete  # 删除空依赖文件

      # 步骤7：构建Host工具（修复staging_dir缺失问题）
      - name: Build Host Tools
        working-directory: ./openwrt
        run: |
          set -e
          make tools/install -j1 V=s  # 单线程更稳健

      # 步骤8：失败后清理重建工具链（补充working-directory，否则执行路径错误）
      - name: Clean & Rebuild Toolchain on Failure
        if: failure()
        working-directory: ./openwrt
        run: |
          make dirclean
          make toolchain/install -j1 V=s

      # 步骤9：单独编译自定义包
      - name: Compile fake-luci-pro Package
        working-directory: ./openwrt
        run: |
          set -e
          make package/fake-luci-pro/clean  # 先清理旧产物
          make package/fake-luci-pro/compile V=s -j$(nproc)

      # 步骤10：上传IPK产物
      - name: Upload IPK Package
        uses: actions/upload-artifact@v4
        with:
          name: fake-luci-pro-ipk
          path: |
            ./openwrt/bin/**/packages/**/fake-luci-pro_*.ipk
            ./openwrt/bin/**/packages/**/fake-luci-pro_*.buildinfo